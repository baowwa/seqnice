# 样本录入设计说明

## 文档目的
- 明确样本录入（单录入、扫码模式、批量导入）的业务目标、功能范围与交互流程。
- 指导UI原型设计与前端实现，统一字段、校验与编码规则。

## 适用范围
- 适用于各类型样本（临床/环境/科研）在“接收/登记”阶段的数据录入与初始配置。
- 适配桌面端优先，移动端以扫码简录为主。

## 术语
- 样本编号：业务唯一编号（如 `S20240115-001`）。
- 样本条码：打印标签上的机器可读码（Code128/QR）。
- 存储位置：仓库→设备→架→层→格位的层级路径。
- QC：质检信息（体积、浓度、纯度、评分等）。

---

## 业务目标与场景
- 快速、准确地录入样本基础信息与合规文件。
- 首次录入即绑定存储位置与初始质检状态。
- 支持单录入、扫码模式、批量导入三种模式；录入后可打印标签并进入后续流程。

## 功能需求概览
1. 单样本录入：标准表单、自动编号、扫码填充、强校验。
2. 扫码模式：聚焦条码输入，最小字段集，快捷键提交。
3. 批量导入：模板下载、文件上传、校验预览、错误修复、确认入库。
4. 质检信息：体积、浓度、纯度（260/280）、质量评分、QC通过标记。
5. 合规文件：伦理审批、知情同意、质检报告（附件上传与校验）。
6. 存储信息：位置层级选择器、温度条件、容器类型、位置编码冲突提醒。
7. 项目信息：关联项目、优先级、预期处理日期。
8. 标签打印与条码：模板选择、份数与尺寸设置、预览与打印记录。
9. 审计与权限：录入人、时间、变更历史，角色权限控制。
10. 校验与去重：必填、范围、字典合法性、条码/编号唯一性。
11. 草稿与恢复：自动保存草稿、异常中断后恢复。
12. 录入后续操作：继续录入、查看详情、导出、跳转到流程节点。

---

## 角色与权限
- 样本接收员：创建/编辑样本、打印标签、上传附件。
- 质检人员：编辑QC信息、变更QC状态。
- 管理员：配置字典、编码规则、位置体系、权限策略。
- 权限校验：无权限用户仅可查看，不能提交或打印。

---

## 交互流程

### 1) 单样本录入
1. 进入页面 → 默认“单录入”。
2. 选择样本类型 → 自动切换相关字段与提示。
3. 扫码或系统生成条码/编号。
4. 填写基础、项目、QC、存储、合规信息。
5. 实时校验通过 → 提交成功 → 提示后续操作（打印/继续录入/查看详情）。

### 2) 扫码模式
1. 焦点锁定到条码输入框，支持扫码枪。
2. 自动填充最小字段集（类型、项目、容器、位置）。
3. Enter 提交，ESC 清空，F2 打印预览。
4. 成功/失败反馈条，成功计数累加。

### 3) 批量导入
1. 下载模板（CSV/Excel）→ 填写数据。
2. 上传文件 → 解析并展示预览表格与错误列表。
3. 支持内联修复或批量规则一键修复（如日期格式、字典映射）。
4. 确认入库 → 结果反馈（成功条数、失败导出）。

---

## 字段与数据模型

### 基础信息
- 样本编号 `code`（必填，唯一，自动生成可手工覆盖）
- 条码 `barcode`（必填，唯一，扫码或生成）
- 样本名称 `name`（必填）
- 样本类型 `sampleTypeId/name`（必填，来自字典）
- 来源 `sampleSource`（选填）
- 接收日期 `receivedDate`（必填）
- 优先级 `priority`（low/medium/high/urgent）

### 项目信息
- 项目ID/名称 `projectId/name`（必填或可选，视业务要求）
- 预期处理日期 `expectedDate`（选填）
- 负责人 `receiverId/name`（系统自动或选择）

### 质检信息（QC）
- 体积 `volume`（数值范围校验）
- 浓度 `concentration`
- 纯度 `purity`（260/280）
- 质量评分 `qualityScore`（0-100）
- 是否通过 `qcPassed`（布尔）
- 备注 `notes`

### 存储信息
- 位置层级：仓库/设备/架/层/格位（树状选择）
- 温度 `temperature`（-80/-20/4/室温）
- 条件 `storageCondition`（冷冻/冷藏/常温/干燥等）
- 容器类型 `containerType`（管/板/袋等）
- 位置编码 `position`（冲突与占用校验）

### 合规与附件
- 伦理审批 `ethics_approval`（附件）
- 知情同意书 `informed_consent`（附件）
- 质检报告 `quality_report`（附件）

### 其他
- 创建/更新时间 `createdAt/updatedAt`
- 审计字段（创建人、修改人、变更说明）

---

## 编码与条码规则
- 编号生成：`S{yyyyMMdd}-{seq}`，序列每日重置，支持项目前缀。
- 条码类型：Code128（打印清晰，适合窄标签）或 QR（信息量大）。
- 冲突处理：编号/条码唯一性校验，重复时提示跳转到既有记录。

---

## 校验规则
- 必填项：编号、条码、类型、接收日期（最小集）
- 范围校验：体积、浓度、纯度、评分在合理范围内。
- 字典合法性：类型/条件/容器等必须来自字典。
- 位置占用：存储位置不可超过容量或被占用；显示已用率。
- 附件要求：支持“暂存不提交”，缺合规文件需标记待补充。

---

## UI原型说明

### 页面结构
- 顶部：面包屑 + 标题“样本接收” + 模式切换（单录入/扫码/批量导入） + 今日统计卡片。
- 主体：双列布局。
  - 左列：录入表单（分组折叠：基础信息、项目信息、质检信息、存储信息、合规与附件）。
  - 右列：样本卡片预览 + 标签预览（可切换模板与份数）。
- 页脚：保存、提交、打印标签、继续录入、新建项目。

### 扫码模式界面
- 大输入框常显焦点，最小字段集，状态反馈条（成功/失败）。
- 快捷键：Enter 提交、ESC 清空、F2 打印预览。

### 批量导入界面（弹窗或页内 Tabs）
- 步骤条：模板 → 上传 → 校验 → 确认。
- 拖拽上传、解析进度、预览表格（错误高亮、内联修复、错误导出）。

### 组件清单
- 位置选择器（树/级联 + 容量与已用率显示）。
- 标签预览与打印配置（模板、尺寸、份数）。
- 附件管理（上传、多选、校验）。

---

## 标签打印与条码
- 字段映射：编号、条码、类型、项目、接收日期、位置。
- 模板管理：支持多模板（窄/宽/QR），按场景切换。
- 打印记录：保留打印时间、份数、打印人。

---

## 审计与日志
- 记录创建/修改/提交、打印与附件变更。
- 变更前后对比（基础字段与QC、位置）。

---

## 接口设计（示意）
- `GET /api/dict/sample-types`：获取样本类型字典。
- `POST /api/samples`：创建样本。
- `POST /api/samples/bulk/validate`：批量校验，返回错误清单。
- `POST /api/samples/bulk/confirm`：批量入库确认。
- `GET /api/storage/locations`：位置树与容量信息。
- `POST /api/labels/print`：标签打印记录。

请求/响应字段与错误码在实现阶段细化。

---

## 异常与错误处理
- 友好提示 + 可恢复策略：草稿保存、错误导出、再次导入。
- 网络或解析失败：降级到最小录入，提示稍后重试。

---

## 性能与扩展建议
- 表单分段渲染与缓存，提高交互流畅度。
- 批量导入采用流式解析与增量校验，避免长阻塞。
- 规则中心与字典外置，支持运营可配置。
- 组件化复用：位置选择器/标签预览/附件管理。

---

## 里程碑与验收标准
1. 原型完成：实现三种模式的UI与基本交互；通过设计评审。
2. 校验完善：覆盖必填、范围、字典、唯一性与位置占用校验。
3. 批量导入：模板、上传、校验、确认闭环可用。
4. 打印标签：模板与预览、份数配置与记录。
5. 审计与权限：基础日志与角色控制生效。

---

## 附：字段清单（示例）

| 分组 | 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- | --- |
| 基础 | 样本编号 | string | 是 | 自动生成可编辑，唯一 |
| 基础 | 条码 | string | 是 | 扫码/生成，唯一 |
| 基础 | 样本名称 | string | 是 | 便于识别 |
| 基础 | 样本类型 | dict | 是 | 来自字典 |
| 项目 | 项目ID/名称 | ref | 视业务 | 关联项目 |
| QC | 体积/浓度/纯度 | number | 否 | 范围校验 |
| QC | 质量评分 | number | 否 | 0-100 |
| 存储 | 位置/温度/条件 | mixed | 视业务 | 层级选择与占用校验 |
| 合规 | 伦理/同意/报告 | file | 视业务 | 附件上传与校验 |
| 其他 | 接收人/日期/备注 | mixed | 视业务 | 审计辅助 |

---

## 原型草图（ASCII）

```
[标题: 样本接收]  [单录入 | 扫码模式 | 批量导入]  [今日统计]

┌ 左：录入表单（折叠分组） ┐      ┌ 右：预览与标签 ┐
| 基础信息                    |      | 样本卡片预览     |
| 项目信息                    |      | 标签预览/份数    |
| 质检信息                    |      └───────────────┘
| 存储信息                    |
| 合规与附件                  |
└───────────────────────────┘
[ 保存 ] [ 提交 ] [ 打印标签 ] [ 继续录入 ] [ 新建项目 ]
```

---

> 备注：本说明用于指导设计与实现。落地到具体页面时，请结合现有字典与后端接口对字段与校验进行细化与对齐。