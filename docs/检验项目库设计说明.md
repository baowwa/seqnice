**目标与唯一性**
- 明确检验项目库的落地边界与数据结构，支撑前处理、检测、质控、报告与审计。
- 复合唯一：`检验项目 + 方法学` 在租户范围内唯一；以此作为“实际可执行的项目”粒度。

**数据模型（核心字段）**
- 基础信息：
  - `projectId`（内部主键）、`projectCode`（编码，租户内唯一）、`projectName`（名称，租户内唯一）
  - `alias`（别名/旧称，可选）、`category`（项目分类/学科）、`department`（归属科室）
  - `status`（0/1：是否启用；可扩展生命周期 `draft/active/review/deprecated/disabled`）
  - `tenantId`、`organizationId`（多租户与组织归属）
- 方法学与设备：
  - `methodologyId/methodologyCode/methodologyName`（方法学字典项）
  - `instrumentModel`（设备型号/平台，如 `PCR/NGS/ELISA`）、`platform`（检测平台）
  - `reagentKit`（试剂盒名称）、`lotNo`（批号）、`validTo`（有效期）
- 样本要求：
  - `sampleType`（如 `血清/血浆/全血/尿`）、`containerType`（容器/管帽颜色）
  - `requiredVolume`（所需体积，mL/μL）、`anticoagulant`（抗凝剂/添加剂）
  - `preprocessWindowMinutes`（采后前处理时间窗）、`transportTemp`（运输温度范围）
  - `transportMaxHours`（最长运输时限）、`stabilityHours`（稳定性时长）
  - `rejectCriteria`（拒收标准：溶血/脂血/黄疸阈值、量不足、容器错误等）
- SOP 配置：
  - `sopId`（SOP 文档/版本绑定）、`sopUrl`（在线文档地址）
  - `sopStepSummary`（关键步骤简述，便于前端展示）
- 质控与性能：
  - 质控材料与频次：`qcInternal`（内控）、`qcExternal`（外控）、`qcFrequency`（每批/每日）
  - 质控规则：`westgardRules[]`、`qcDecision`（超限处置策略）
  - 校准：`calibrationCycle`（校准周期）、`calibrator`（校准材料）
  - 性能指标：`LoD`（检出限）、`LoQ`（定量限）、`linearityRange`（线性区间）
  - 精密度与准确度：`cvWithin%/cvBetween%`、`bias`（与参比方法比对偏倚）
  - 干扰因素：`interferences[]`（溶血/脂血/黄疸、药物等）
- 生信应用关联（用于生信分析）：
  - `bioAppId`（生信应用/流程ID）、`bioAppVersion`（版本）
  - `pipelineId`（具体流水线/Workflow ID）、`pipelineParams`（参数JSON，含默认阈值）
  - `inputMapping`（实验数据到管道输入的映射，如 `FASTQ/BAM/VCF` 路径字段）
  - `outputArtifacts`（产物类型与存储位置，如 `VCF/统计表/图像`）
- 报告模板关联：
  - `reportTemplateId`、`reportTemplateVersion`
  - `reportSections[]`（动态段落：结论、提示、方法、结果图表等）
  - `variablesMapping`（结果变量与模板变量的绑定，如 `Ct值/变异数/风险等级`）
- 业务与计费：
  - `tatTargetHours/tatMaxHours`（周转时间：目标/上限）
  - `chargeCode`（计费代码）、`price`（价格）、`isInsuranceCovered`（医保覆盖）
- 字典与标准映射：
  - `loincCode/snomedCode/cptCode/icd10`（标准编码映射，按需）
  - `unit`（单位）、`decimalPlaces`（小数位）、`resultType`（定性/定量）
- 版本与审计：
  - `version`、`effectiveDate`、`expireDate`、`changeLog[]`
  - `createdAt/updatedAt`、`createdBy/updatedBy`

**关系与约束**
- 复合唯一约束：`(projectCode | projectName) + methodologyId` 在 `tenantId` 范围内唯一。
- 外键关系：
  - `methodologyId` → 方法学字典；`instrumentModel` → 设备字典；`unit`/`sampleType`/`containerType` → 字典。
  - `bioAppId/pipelineId` → 生信应用目录；`reportTemplateId` → 报告模板库；`sopId` → 文档库。
- 状态约束：`status` 存储为 `tinyint(2)` 的 0/1；前端 `Switch` 使用 `boolean`，提交时做 0/1 映射。

**页面与流程建议**
- 页签划分：
  - 基础信息｜方法学与设备｜样本要求｜SOP｜质控与性能｜生信应用｜报告模板｜计费与TAT｜版本与审计。
- 校验规则：
  - 体积正数、温度范围合理、时间窗/稳定性为非负整数；`LoD/LoQ/线性区间` 为数值并校验区间。
  - 参考区间需有人群维度（年龄/性别/人群标签）；名称/编码/复合唯一性需后端校验。
  - 若绑定了 `bioAppId`，应要求 `pipelineId` 与 `inputMapping` 完整。
- 联动逻辑：
  - 选择方法学后，带出默认单位/小数位/参考区间与设备平台；变更方法学触发性能指标校验。
  - 绑定报告模板后，动态展示模板变量并提示未映射变量。

**最小可用集（MVP，建议先落地）**
- 基础：`projectCode/projectName/status`、`tenantId`。
- 方法学与设备：`methodologyId`、`instrumentModel`（字典）。
- 样本要求：`sampleType`、`requiredVolume`、`transportTemp`、`stabilityHours`、`rejectCriteria`。
- SOP：`sopId/sopUrl`。
- 质控与性能：`qcFrequency`、`LoD/LoQ/linearityRange`、`cvWithin%`。
- 生信应用：`bioAppId/pipelineId/pipelineParams`、`inputMapping`（至少 `FASTQ`）。
- 报告模板：`reportTemplateId/reportTemplateVersion`、`variablesMapping`（必要变量完成映射）。
- 计费与TAT：`tatTargetHours/tatMaxHours`、`chargeCode/price`。

**与现有代码的衔接建议**
- `src/pages/InspectionProject/Library.tsx` 的启用状态注释已为 `0/1`，前端表单 `Switch` 建议使用 `boolean` 并在提交时做 0/1 映射（与 `Standard.tsx` 保持一致）。
- 可按页签逐步补齐字段，列表页支持按方法学、样本类型、状态筛选；详情页支持版本查看与复制为新版本。

**后续扩展**
- 合规：ISO 15189/CLSI 验证记录与外部质评（EQA/PT）绑定。
- 运维：产能与排程、批次大小、失败重试与复测策略、人工复核要求。
- 可观察性：执行日志、关键节点耗时、异常告警与审计追踪。

**小结**
- 检验项目库应以“检验项目 + 方法学”为唯一实体，向下关联样本要求、SOP、质控与性能、再到生信应用与报告模板，横向贯通计费/TAT与审计/版本。以上字段与约束即可支撑从样本接收到报告发布的完整闭环。

---

**范围限定（优化版）**
- 本稿按你的要求，先不包含以下模块：
  - 业务与计费（价格、医保、计费代码、TAT）
  - 版本与审计（版本时间线、生效/过期、审计日志与操作者）
- 其余模块按“可落地最小集”完整设计，并明确校验与联动。

**优化版功能清单（不含计费与版本审计）**
- 基础信息与唯一性：`testCode/testName/status(0/1)`、`tenantId`；唯一约束为 `(testCode | testName) + methodologyId + tenantId`。
- 方法学与设备：`methodologyId/methodologyName`、`instrumentModel/platform`、`reagentKit/lotNo/validTo`。
- 样本要求：`sampleType/containerType/requiredVolume/anticoagulant/transportTemp/transportMaxHours/stabilityHours/rejectCriteria`。
- SOP 配置：`sopId/sopUrl/sopStepSummary`（关键步骤摘要用于前端展示与审核流程）。
- 质控与性能：`qcInternal/qcExternal/qcFrequency/westgardRules/calibrationCycle/LoD/LoQ/linearityRange/cvWithin%/cvBetween%/bias/interferences[]`。
- 生信应用：
  - `requiresBioinformatics:boolean`（前端开关，保存时映射为 `0/1`）。
  - 当为真：必须绑定 `bioAppId/pipelineId/pipelineParams(input JSON)/inputMapping(FASTQ/BAM/VCF)/outputArtifacts`。
- 报告模板：`reportTemplateId/reportTemplateVersion/variablesMapping[]`（未映射变量禁止启用）。
- 字典与标准映射：方法学、设备、样本类型、容器、单位；标准编码 `loinc/snomed/cpt` 按需映射。

**优化版界面设计**
- 列表页（检验项目库）：
  - 查询与筛选：关键词（名称/编码）、方法学、样本类型、状态、是否生信。
  - 列定义：`testCode/testName/methodologyName/sampleType/instrumentModel/status(Switch)/requiresBioinformatics(Tag)`；操作列：查看｜编辑｜启用/停用。
  - 提示：不展示计费与版本信息；启用按钮触发前置检查（见下）。
- 新建/编辑页（页签布局）：
  1) 基础信息
  2) 方法学与设备
  3) 样本要求
  4) SOP
  5) 质控与性能
  6) 生信应用（由“是否需要生信分析”开关驱动显示）
  7) 报告模板（模板选择与变量映射）
- 详情页：展示以上七个区块的信息；不包含版本时间线与计费信息。
- 字段与交互：
  - `status` 使用前端 `Switch:boolean`，提交映射为后端 `tinyint(2)` 的 `0/1`（与你当前 `Library.tsx` 注释一致）。
  - 方法学变化联动单位/小数位/参考区间与设备平台；开启生信开关后显示并要求完整配置。
  - 页签级错误徽标；保存与启用前统一校验并定位第一个错误字段。

**前置检查（启用前）**
- 报告模板：`reportTemplateId` 存在且 `variablesMapping[]` 覆盖所有必需变量。
- 样本要求：体积/温度/时间窗/稳定性均通过数值校验；拒收标准不为空（至少填写一项）。
- 质控与性能：`qcFrequency` 有值；`LoD/LoQ/linearityRange` 为数值并区间合理；如配置 Westgard 规则则格式合法。
- 生信应用：当 `requiresBioinformatics=true`，`bioAppId/pipelineId/inputMapping` 必填，`pipelineParams` 存在且 JSON 合法。

**接口与数据约定（优化版）**
- 列表查询：`GET /api/tests?keyword&methodologyId&sampleType&status&requiresBioinformatics`
- 新建：`POST /api/tests`（前端布尔 `status/requiresBioinformatics` 提交时转 `0/1`）
- 编辑：`PUT /api/tests/{id}`
- 启用/停用：`PATCH /api/tests/{id}/status`（`0/1`）
- 说明：不提供版本复制与计费相关接口；审计字段非必需。

**校验与联动细则**
- 数值校验：
  - `requiredVolume>0`；`transportTemp` 为区间字符串（如 `2-8℃`），可后端解析校验；`transportMaxHours/stabilityHours` 为非负整数。
  - `LoD/LoQ/linearityRange` 为数值，`LoD<=LoQ`，线性区间为 `min<max`。
- 字典校验：`methodologyId/instrumentModel/sampleType/containerType/unit` 必须来自字典；自由文本仅限摘要类字段（如 `sopStepSummary/rejectCriteria`）。
- 联动：
  - 更换 `methodologyId` 时提示“方法学变更将影响单位/参考区间与性能参数，需要复核”；可选择自动替换默认值。
  - 开启 `requiresBioinformatics` 时，未完成 `bioAppId/pipelineId/inputMapping` 禁止保存或启用。

**测试建议（优化版）**
- 单元：唯一性校验、数值与区间校验、布尔开关转 `0/1` 映射、联动逻辑（方法学变更与生信开关）。
- 端到端：新建→保存→启用前置检查→启用；编辑→校验；不涉及版本复制与计费。
- UI：页签错误定位、字典选择器可用性、模板变量映射完整性提示、生信开关驱动显示/隐藏。

**需求设计**
- 背景与目标：构建“检验项目（Test）+ 方法学（Assay）唯一”的可执行项目库，贯通样本、SOP、质控、性能、生信、报告与计费，支撑 ISO15189/CLSI 合规与可运营性。
- 术语与唯一性：`(testCode | testName) + methodologyId` 在 `tenantId` 范围内唯一；`status` 使用 `0/1` 存储，前端 `Switch:boolean`。
- 功能范围：
  - 项目CRUD：新建/编辑/复制为新版本/启用停用/归档；版本生效与过期控制。
  - 方法学绑定：方法学改变触发单位、小数位、参考区间与设备平台联动校验。
  - 样本要求：样本类型、容器、体积、抗凝剂、运输温度与时限、稳定性、拒收标准。
  - SOP 配置：绑定 SOP 文档与版本，保留关键步骤摘要用于前端展示与审核。
  - 质控与性能：质控材料/频次、Westgard 规则、校准周期、LoD/LoQ/线性区间、CV%、偏倚、干扰因素。
  - 生信应用：当 `requiresBioinformatics=true` 时，必须绑定 `bioAppId/pipelineId/pipelineParams/inputMapping/outputArtifacts`。
  - 报告模板：`reportTemplateId/version` 与 `variablesMapping[]`；缺失映射时阻止启用并提示。
  - 计费与 TAT：`tatTargetHours/tatMaxHours`、`chargeCode/price/isInsuranceCovered`。
  - 字典与标准：方法学、设备、样本类型、容器、单位、标准编码（LOINC/SNOMED/CPT）。
  - 权限与审计：角色视图权限、操作审计、`createdBy/updatedBy` 与时间戳。
- 约束与校验：
  - 复合唯一：`(testCode | testName) + methodologyId + tenantId` 必须唯一。
  - 数值校验：体积>0；温度为区间；时间窗/稳定性为非负整数；`LoD/LoQ/线性区间` 必须为数值且范围合理。
  - 联动校验：方法学改变时，提示性能参数需复核；若 `requiresBioinformatics=true` 则强制填写管道与映射。
  - 启用前置检查：报告模板变量映射完整、样本与质控信息完整、生信配置（如需）完整，否则禁止启用。
- 交互流程：
  - 新建流程：填写基础→选方法学→样本与 SOP → 质控与性能 →（可选）生信应用 → 报告模板 → 计费/TAT → 校验与保存。
  - 启用流程：运行前置检查，若通过则设置 `status=1`；否则提示缺失项与定位页签。
  - 版本变更：从详情页“复制为新版本”，更新差异字段，设置新 `version` 与 `effectiveDate`，保存后旧版本可自动过期或手动失效。

**界面设计**
- 信息结构与导航：
  - 列表页（检验项目库）：支持搜索与筛选（项目名/编码、方法学、样本类型、状态、是否生信）；操作列包含“查看｜编辑｜复制为新版本｜启用/停用”。
  - 新建/编辑页：采用页签布局，包含：
    1) 基础信息（`testCode/testName/status/tenantId`）
    2) 方法学与设备（`methodologyId/instrumentModel/platform/reagentKit/lotNo/validTo`）
    3) 样本要求（`sampleType/containerType/requiredVolume/anticoagulant/transportTemp/transportMaxHours/stabilityHours/rejectCriteria`）
    4) SOP（`sopId/sopUrl/sopStepSummary`）
    5) 质控与性能（`qcInternal/qcExternal/qcFrequency/westgardRules/calibrationCycle/LoD/LoQ/linearityRange/cvWithin%/cvBetween%/bias/interferences`）
    6) 生信应用（`requiresBioinformatics` 开关；开启后展示 `bioAppId/pipelineId/pipelineParams/inputMapping/outputArtifacts`）
    7) 报告模板（`reportTemplateId/version/variablesMapping[]`，未映射变量高亮提示）
    8) 计费与 TAT（`tatTargetHours/tatMaxHours/chargeCode/price/isInsuranceCovered`）
    9) 版本与审计（只读：`version/effectiveDate/expireDate/changeLog/createdAt/updatedAt`）
- 字段布局与交互：
  - 表单采用两列布局，长文本（拒收标准、SOP 摘要）使用多行输入；数值字段带单位提示与范围校验。
  - 联动：方法学变化时弹出确认，更新默认单位/小数位/参考区间；开启生信开关后显示必填区块。
  - 校验提示：页签级错误徽标；保存/启用前统一校验，定位到第一个错误字段。
- 列表页列定义：
  - 关键列：`testCode`、`testName`、`methodologyName`、`sampleType`、`instrumentModel`、`status`（Switch）
  - 质控摘要：`qcFrequency/LoD/LoQ`（缩略显示）；生信标记：`requiresBioinformatics`（Tag）
- 详情页：
  - 展示所有区块信息；支持版本时间线与差异对比；支持“复制为新版本”。
- 控件与字典：
  - 字典选择：方法学、设备、样本类型、容器、单位使用选择器；报告模板与生信应用使用检索选择器。
  - 状态开关：`Switch:boolean`，保存时映射为 `tinyint(2)` 的 `0/1`（与 `src/pages/InspectionProject/Library.tsx` 注释一致）。

**接口与数据约定（前后端）**
- 列表查询：`GET /api/tests?keyword&methodologyId&sampleType&status&requiresBioinformatics`
- 新建：`POST /api/tests`（前端 `boolean` 字段：`status/requiresBioinformatics` 提交时转 `0/1`；`variablesMapping` 为数组）
- 编辑：`PUT /api/tests/{id}`；启用/停用：`PATCH /api/tests/{id}/status`（`0/1`）
- 版本复制：`POST /api/tests/{id}/clone`（生成新 `version` 与 `effectiveDate`）
- 示例负载（片段）：
  ```json
  {
    "testCode": "HBV-DNA",
    "testName": "乙肝病毒DNA定量",
    "methodologyId": 12,
    "status": 1,
    "sample": {"type": "血清", "requiredVolume": 0.5, "transportTemp": "2-8℃", "stabilityHours": 24},
    "sop": {"sopId": 301, "sopUrl": "https://docs/sop/301"},
    "qc": {"frequency": "每批", "LoD": 20, "LoQ": 50, "cvWithin": 3.5},
    "bio": {"requiresBioinformatics": 1, "bioAppId": 9, "pipelineId": 22, "inputMapping": {"FASTQ": "path"}},
    "report": {"templateId": 15, "templateVersion": "v2", "variablesMapping": [{"var": "viralLoad", "source": "result.value"}]},
    "tat": {"targetHours": 24, "maxHours": 48}
  }
  ```

**测试建议**
- 单元校验：数值范围、复合唯一、联动（方法学变更与生信开关）逻辑；报告变量映射完整性。
- 端到端：新建→启用前置检查→启用→复制为新版本→比对差异。
- UI 交互：页签错误定位、字典选择器与联动、开关驱动显示/隐藏必填区块。