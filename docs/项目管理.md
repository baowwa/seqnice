## 一、关系定义

### 1. 核心概念定义

```plaintext
项目 (Project)
├── 是否多中心 (is_multi_center)
│   ├── 单中心项目：只有一个执行机构
│   └── 多中心项目：多个机构协作，需要统一标准
└── 是否多阶段 (is_multi_stage)
    ├── 单阶段项目：一次性完成所有工作
    └── 多阶段项目：分步骤推进，每个阶段目标不同
```

### 2. 业务意义

**多中心的业务场景：**
- 临床试验：多家医院同时参与
- 科研合作：多个实验室协作
- 产品验证：在不同地区进行性能验证

**多阶段的业务场景：**
- 产品注册：研发→验证→临床→申报
- 科研服务：方案设计→样本检测→数据分析
- 技术开发：原理验证→工艺优化→生产验证

## 二、数据库表结构设计

### 1. 核心表结构

```sql
-- 项目主表
CREATE TABLE projects (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    project_code VARCHAR(50) UNIQUE NOT NULL,  -- 项目编号
    project_name VARCHAR(200) NOT NULL,        -- 项目名称
    project_type VARCHAR(50) NOT NULL,         -- 项目类型
    is_multi_center BOOLEAN DEFAULT FALSE,     -- 是否多中心
    is_multi_stage BOOLEAN DEFAULT FALSE,      -- 是否多阶段
    client_id BIGINT,                          -- 客户ID
    contract_id BIGINT,                        -- 合同ID
    start_date DATE,
    end_date DATE,
    status VARCHAR(20) DEFAULT 'PLANNING',     -- 状态
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 项目阶段表
CREATE TABLE project_stages (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    project_id BIGINT NOT NULL,
    stage_code VARCHAR(50) NOT NULL,           -- 阶段编号
    stage_name VARCHAR(100) NOT NULL,          -- 阶段名称
    stage_type VARCHAR(50) NOT NULL,           -- 阶段类型
    sequence INT NOT NULL,                     -- 阶段顺序
    plan_start_date DATE,
    plan_end_date DATE,
    actual_start_date DATE,
    actual_end_date DATE,
    status VARCHAR(20) DEFAULT 'PLANNING',
    objectives TEXT,                           -- 阶段目标
    deliverables TEXT,                         -- 交付物
    FOREIGN KEY (project_id) REFERENCES projects(id)
);

-- 项目中心表
CREATE TABLE project_centers (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    project_id BIGINT NOT NULL,
    center_code VARCHAR(50) NOT NULL,          -- 中心编号
    center_name VARCHAR(100) NOT NULL,         -- 中心名称
    institution_id BIGINT,                     -- 机构ID
    institution_name VARCHAR(200),             -- 机构名称
    principal_investigator VARCHAR(100),       -- 主要研究者
    contact_info VARCHAR(200),                 -- 联系方式
    address TEXT,                              -- 地址
    is_lead_center BOOLEAN DEFAULT FALSE,      -- 是否牵头中心
    status VARCHAR(20) DEFAULT 'ACTIVE',
    FOREIGN KEY (project_id) REFERENCES projects(id)
);

-- 阶段-中心关联表（多对多）
CREATE TABLE stage_center_assignments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    stage_id BIGINT NOT NULL,
    center_id BIGINT NOT NULL,
    tasks TEXT,                                -- 分配的任务
    sample_quantity INT,                       -- 样本数量
    status VARCHAR(20) DEFAULT 'ASSIGNED',
    FOREIGN KEY (stage_id) REFERENCES project_stages(id),
    FOREIGN KEY (center_id) REFERENCES project_centers(id)
);

-- 阶段检测任务表
CREATE TABLE stage_detection_tasks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    stage_id BIGINT NOT NULL,
    detection_item_id BIGINT NOT NULL,         -- 检测项目ID
    target_sample_count INT,                   -- 目标样本数
    completed_sample_count INT DEFAULT 0,      -- 已完成样本数
    quality_requirements TEXT,                 -- 质量要求
    data_requirements TEXT,                    -- 数据要求
    FOREIGN KEY (stage_id) REFERENCES project_stages(id)
);
```

## 三、界面设计

### 1. 项目创建界面 - 多中心多阶段配置

```plaintext
┌──────────────────────────────────────────────────────────────────────────────┐
│                           创建新项目                                         │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ 基础信息                                                               │  │
│  ├────────────────────────────────────────────────────────────────────────┤  │
│  │ 项目名称: [__________________________________________________________] │  │
│  │ 项目分类: [产品注册项目                         ▼]                     │  │
│  │ 客户名称: [XX生物科技有限公司                   ▼]                     │  │
│  │ 合同编号: [HT-2024-001                       ]                         │  │
│  │ 时间周期: [2024-01-15] 至 [2024-12-31]                                │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ 项目结构配置                                                           │  │
│  ├────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                        │  │
│  │  项目组织形式:                                                         │  │
│  │  ○ 单中心单阶段    ● 单中心多阶段    ○ 多中心单阶段    ○ 多中心多阶段  │  │
│  │                                                                        │  │
│  │  ┌─────────────────┐  ┌─────────────────┐                             │  │
│  │  │  多中心设置     │  │  多阶段设置     │                             │  │
│  │  ├─────────────────┤  ├─────────────────┤                             │  │
│  │  │ ☑ 启用多中心管理 │  │ ☑ 启用多阶段管理 │                             │  │
│  │  │                  │  │                  │                             │  │
│  │  │ 牵头中心:        │  │ 阶段模板:        │                             │  │
│  │  │ [本实验室        ▼] │ [产品注册项目    ▼]                             │  │
│  │  │                  │  │                  │                             │  │
│  │  │ 协作中心:        │  │ 自定义阶段:      │                             │  │
│  │  │ [添加协作中心]    │  │ [添加阶段]       │                             │  │
│  │  └─────────────────┘  └─────────────────┘                             │  │
│  │                                                                        │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌─────────────────────┐  ┌─────────────────────┐                          │
│  │      [ 下一步 ]      │  │      [ 取消 ]        │                          │
│  └─────────────────────┘  └─────────────────────┘                          │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 2. 多中心配置界面

```plaintext
┌──────────────────────────────────────────────────────────────────────────────┐
│                        多中心配置 - 结核耐药检测多中心研究                   │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ 中心列表                                                               │  │
│  ├────────────────────────────────────────────────────────────────────────┤  │
│  │ ┌─ 中心1 ─────────────────────────────────────────────────────────────┐ │  │
│  │ │ ● 牵头中心: 本实验室                                                 │ │  │
│  │ │   机构: XX检测中心                   负责人: 张主任                   │ │  │
│  │ │   样本任务: 200例                   进度: 150/200 (75%)             │ │  │
│  │ │   [编辑] [分配任务] [数据监控]                                       │ │  │
│  │ └────────────────────────────────────────────────────────────────────┘ │  │
│  │ ┌─ 中心2 ─────────────────────────────────────────────────────────────┐ │  │
│  │ │ ● 协作中心: 北京协和医院                                             │ │  │
│  │ │   机构: 北京协和医院检验科           负责人: 王主任                   │ │  │
│  │ │   样本任务: 150例                   进度: 120/150 (80%)             │ │  │
│  │ │   [编辑] [分配任务] [数据监控]                                       │ │  │
│  │ └────────────────────────────────────────────────────────────────────┘ │  │
│  │ ┌─ 中心3 ─────────────────────────────────────────────────────────────┐ │  │
│  │ │ ● 协作中心: 上海瑞金医院                                             │ │  │
│  │ │   机构: 上海瑞金医院中心实验室       负责人: 李主任                   │ │  │
│  │ │   样本任务: 150例                   进度: 90/150 (60%)              │ │  │
│  │ │   [编辑] [分配任务] [数据监控]                                       │ │  │
│  │ └────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                        │  │
│  │ [添加协作中心] [导入中心列表] [批量分配任务]                           │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ 统一标准配置                                                           │  │
│  ├────────────────────────────────────────────────────────────────────────┤  │
│  │ 方法学标准: [荧光PCR熔解曲线法                    ] [查看标准]          │  │
│  │ SOP文档:   [结核耐药基因检测统一SOP V2.1         ] [下载]             │  │
│  │ 质控要求:  [统一室内质控规则                     ] [配置]             │  │
│  │ 数据格式:  [统一数据采集模板                     ] [下载模板]          │  │
│  │ 报告模板:  [统一检测报告模板                     ] [预览]             │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 3. 多阶段配置界面

```plaintext
┌──────────────────────────────────────────────────────────────────────────────┐
│                        多阶段配置 - 结核耐药检测多中心研究                   │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │   阶段1:研发验证 │  │   阶段2:临床试验 │  │   阶段3:注册申报 │              │
│  │   ● 进行中      │  │   ○ 待开始      │  │   ○ 计划中      │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ 阶段详情 - 研发验证阶段                                                │  │
│  ├────────────────────────────────────────────────────────────────────────┤  │
│  │ 时间周期: 2024-01-15 至 2024-06-30                                    │  │
│  │ 阶段目标: 完成结核耐药检测试剂盒的性能验证与标准化                     │  │
│  │ 交付物: 性能验证报告、标准化SOP、质量控制方案                         │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ 阶段任务分配                                                           │  │
│  ├────────────────────────────────────────────────────────────────────────┤  │
│  │ ┌──────────────┬──────────────┬─────────────────┬────────────────────┐ │  │
│  │ │    任务      │   负责中心   │     样本任务     │       进度         │ │  │
│  │ ├──────────────┼──────────────┼─────────────────┼────────────────────┤ │  │
│  │ │ 方法学建立   │ 本实验室     │ 50例            │ ▓▓▓▓▓▓▓▓░░ 80%    │ │  │
│  │ │ 性能验证     │ 本实验室     │ 100例           │ ▓▓▓▓▓░░░░░ 50%    │ │  │
│  │ │ 对比研究     │ 北京协和医院 │ 150例           │ ▓▓▓▓▓▓▓░░░ 70%    │ │  │
│  │ │ 重复性评价   │ 上海瑞金医院 │ 100例           │ ▓▓▓░░░░░░░ 30%    │ │  │
│  │ └──────────────┴──────────────┴─────────────────┴────────────────────┘ │  │
│  │                                                                        │  │
│  │ [添加任务] [重新分配] [进度更新]                                       │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │ 阶段流转条件                                                           │  │
│  ├────────────────────────────────────────────────────────────────────────┤  │
│  │ ☑ 所有中心任务完成率达到100%                                           │  │
│  │ ☑ 数据质量通过统一审核                                                 │  │
│  │ ☑ 阶段报告通过审批                                                     │  │
│  │ ☑ 下一阶段资源准备就绪                                                 │  │
│  │                                                                        │  │
│  │ [申请阶段结束] [进入下一阶段]                                         │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

## 四、业务逻辑设计

### 1. 多中心管理逻辑
```javascript
// 伪代码：多中心任务分配
function assignMultiCenterTasks(projectId, stageId) {
    const centers = getProjectCenters(projectId);
    const leadCenter = centers.find(c => c.is_lead_center);
    
    // 牵头中心负责方法学建立和标准制定
    assignTask(leadCenter.id, stageId, '方法学建立', 50);
    assignTask(leadCenter.id, stageId, '性能验证', 100);
    
    // 协作中心负责样本验证
    const collaborativeCenters = centers.filter(c => !c.is_lead_center);
    collaborativeCenters.forEach(center => {
        assignTask(center.id, stageId, '对比研究', 150);
        assignTask(center.id, stageId, '重复性评价', 100);
    });
}
```

### 2. 多阶段流转逻辑
```javascript
// 伪代码：阶段流转检查
function canProceedToNextStage(projectId, currentStageId) {
    const conditions = [
        checkAllTasksCompleted(projectId, currentStageId),
        checkDataQualityApproved(projectId, currentStageId),
        checkStageReportApproved(projectId, currentStageId),
        checkNextStageResourcesReady(projectId, currentStageId)
    ];
    
    return conditions.every(condition => condition === true);
}
```

## 五、配置策略

### 1. 项目模板配置
```plaintext
项目模板库
├── 产品注册项目模板
│   ├── 多中心: 是
│   ├── 多阶段: 是
│   └── 预设阶段: [研发验证, 临床试验, 注册申报]
├── 科研服务项目模板
│   ├── 多中心: 否
│   ├── 多阶段: 是
│   └── 预设阶段: [方案设计, 样本检测, 数据分析]
└── 临床检测项目模板
    ├── 多中心: 否
    ├── 多阶段: 否
    └── 预设阶段: [样本检测]
```