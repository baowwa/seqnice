您说得非常对！实验过程中的数据记录是至关重要的。我来重新设计一个完整的实验任务界面，重点加强每个步骤的数据记录功能。

# 完整的实验任务界面设计（增强数据记录版）

## 1. 实验任务中心首页（保持不变）

```
┌─────────────────────────────────────────────────────────┐
│ 实验任务中心                            [创建新批次] [+] │
├─────────────────────────────────────────────────────────┤
│ 🔘 待分配样本(15)    🔘 进行中批次(3)    🔘 已完成     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│ 待分配样本列表:                                         │
│ ┌──┬──────┬──────────┬────────┬──────────┬────────────┐ │
│ │□ │ S001 │ 样本1    │ DNA   │ 2024-05-20│ [加入批次] │ │
│ │□ │ S002 │ 样本2    │ RNA   │ 2024-05-20│ [加入批次] │ │
│ │□ │ S003 │ 样本3    │ DNA   │ 2024-05-20│ [加入批次] │ │
│ │□ │ S004 │ 样本4    │ DNA   │ 2024-05-20│ [加入批次] │ │
│ └──┴──────┴──────────┴────────┴──────────┴────────────┘ │
│                                                         │
│ [全选] [创建新批次并加入选中样本(3)]                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 2. 实验批次详情页（增强数据记录功能）

```
┌─────────────────────────────────────────────────────────┐
│ 实验批次: EXP_20240520_001             [返回列表] [设置]│
├─────────────────────────────────────────────────────────┤
│ 批次信息:                                              │
│ ┌─────────────────┬─────────────────┬─────────────────┐ │
│ │ 状态: 🔄 进行中  │ 负责人: 张三    │ 创建: 05-20 09:30│ │
│ │ 样本数: 3个     │ 项目: 肿瘤测序  │ 预计完成: 今天  │ │
│ └─────────────────┴─────────────────┴─────────────────┘ │
│                                                         │
│ 步骤跟踪:                                              │
│ ○○○○○○○○○●○○○○○○○○○○○○○○○○ 60% 完成                   │
│                                                         │
│ 实验步骤与数据记录:                                    │
│ ┌──────────────┬───────────┬───────────┬─────────────┐ │
│ │    步骤      │   状态    │  数据记录 │   时间      │ │
│ ├──────────────┼───────────┼───────────┼─────────────┤ │
│ │ 样本前处理   │ ✅ 完成   │ [查看/编辑]│ 09:30-10:00 │ │
│ │ 核酸提取     │ ✅ 完成   │ [查看/编辑]│ 10:00-11:30 │ │
│ │ PCR扩增      │ 🔄 进行中 │ [继续记录]│ 14:30-      │ │
│ │ 文库构建     │ ⏳ 待开始 │ [开始记录]│ -           │ │
│ │ 文库定量     │ ⏳ 待开始 │ [开始记录]│ -           │ │
│ │ 最终QC       │ ⏳ 待开始 │ [开始记录]│ -           │ │
│ └──────────────┴───────────┴───────────┴─────────────┘ │
│                                                         │
│ 📝 当前步骤实时记录:                                   │
│ [快速记录异常] [上传附件] [添加备注]                  │
│                                                         │
│ 样本列表: S001(样本1), S002(样本2), S003(样本3)       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 3. 步骤数据记录表单设计

### 通用记录表单框架
每个步骤都包含以下部分：
- **基本信息**：操作员、时间、仪器等
- **样本级数据**：每个样本的具体结果
- **批次级数据**：整个批次的通用参数
- **质量控制**：QC标准和结果
- **附件上传**：相关文件和图片

### 核酸提取步骤记录界面
```
┌─────────────────────────────────────────────────────────┐
│ 核酸提取 - 数据记录                [保存草稿] [完成步骤] │
├─────────────────────────────────────────────────────────┤
│ 基本信息:                                              │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 操作人员: 张三                   开始: 2024-05-20 10:00│ │
│ │ 提取方法: ▾ 磁珠法               结束: 2024-05-20 11:30│ │
│ │ 试剂盒: ▾ QIAGEN DNeasy Blood & Tissue Kit         │ │
│ │ 试剂批号: 202405001            仪器: 离心机001,水浴锅002│ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ 样本提取结果记录:                                      │
│ ┌──┬──────┬──────────┬─────────┬─────────┬───────────┐ │
│ │  │ 样本 │ 浓度(ng/μl)│ 体积(μl)│ 260/280 │   操作    │ │
│ ├──┼──────┼──────────┼─────────┼─────────┼───────────┤ │
│ │  │ S001 │  [45.2]  │  [50]   │ [1.85]  │ [重测]    │ │
│ │  │ S002 │  [38.7]  │  [50]   │ [1.92]  │ [重测]    │ │
│ │  │ S003 │  [12.1]  │  [50]   │ [1.78]  │ [重测]    │ │
│ └──┴──────┴──────────┴─────────┴─────────┴───────────┘ │
│                                                         │
│ 批量操作: [填充相同体积] [计算平均值] [验证数据]       │
│                                                         │
│ 提取参数:                                              │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 裂解时间: [30] 分钟    │ 洗脱体积: [50] μl          │ │
│ │ 酶处理: ▾ 有          │ 温度: [56] ℃               │ │
│ │ 特殊处理: [_________________________________]       │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ 质量控制:                                              │
│ ▢ 浓度检查: 所有样本 > 10ng/μl                        │ │
│ ▢ 纯度检查: 260/280在1.8-2.0之间                      │ │
│ ▢ 完整性: 电泳检测通过                                │ │
│                                                         │
│ 附件: [上传电泳图] [上传检测报告] [拍照]              │
│                                                         │
│ 备注: [______________________________________________] │ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### PCR扩增步骤记录界面
```
┌─────────────────────────────────────────────────────────┐
│ PCR扩增 - 数据记录                  [保存草稿] [完成步骤]│
├─────────────────────────────────────────────────────────┤
│ 基本信息:                                              │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 操作人员: 张三                   开始: 2024-05-20 14:30│ │
│ │ PCR仪: ▾ Applied Biosystems 9700 (PCR-002)         │ │
│ │ 程序模板: ▾ 标准DNA扩增          预计结束: 16:30     │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ PCR反应体系记录:                                       │
│ ┌─────────────────┬─────────┬─────────┬───────────────┐ │
│ │     组分        │ 体积(μl)│  批号   │     备注      │ │
│ ├─────────────────┼─────────┼─────────┼───────────────┤ │
│ │ ▾ 模板DNA       │  [5.0]  │         │               │ │
│ │ ▾ PCR Mix       │ [25.0]  │202405001│               │ │
│ │ ▾ 引物F         │  [2.0]  │202405002│               │ │
│ │ ▾ 引物R         │  [2.0]  │202405002│               │ │
│ │ ▾ 水            │ [16.0]  │         │               │ │
│ │     总计        │  50.0   │         │               │ │
│ └─────────────────┴─────────┴─────────┴───────────────┘ │
│                                                         │
│ PCR程序参数:                                           │
│ ┌──────────┬────────┬───────────┬─────────────────────┐ │
│ │   步骤   │ 温度℃  │   时间    │       循环数        │ │
│ ├──────────┼────────┼───────────┼─────────────────────┤ │
│ │ 预变性   │  [95]  │   [5min]  │         [1]         │ │
│ │ 变性     │  [95]  │  [30s]    │        [35]         │ │
│ │ 退火     │  [58]  │  [30s]    │        [35]         │ │
│ │ 延伸     │  [72]  │  [1min]   │        [35]         │ │
│ │ 终延伸   │  [72]  │  [5min]   │         [1]         │ │
│ │ 保存     │   [4]  │    ∞      │         [1]         │ │
│ └──────────┴────────┴───────────┴─────────────────────┘ │
│                                                         │
│ 样本分配记录:                                          │
│ ┌──────┬──────┬────────────┬──────────┬──────────────┐ │
│ │ 位置 │ 样本 │  反应体系  │  状态    │    备注      │ │
│ ├──────┼──────┼────────────┼──────────┼──────────────┤ │
│ │ A01  │ S001 │  标准体系  │  已完成  │              │ │
│ │ A02  │ S002 │  标准体系  │  已完成  │              │ │
│ │ A03  │ S003 │  标准体系  │  已完成  │              │ │
│ └──────┴──────┴────────────┴──────────┴──────────────┘ │
│                                                         │
│ [从模板加载] [验证程序] [上传扩增曲线]                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 文库构建步骤记录界面
```
┌─────────────────────────────────────────────────────────┐
│ 文库构建 - 数据记录                  [保存草稿] [完成步骤]│
├─────────────────────────────────────────────────────────┤
│ 基本信息:                                              │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 操作人员: 张三                   开始: 2024-05-20 16:00│ │
│ │ 建库方法: ▾ Illumina Nextera XT                    │ │
│ │ 试剂盒批号: 202405003           仪器: 各种实验设备    │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ 文库构建参数:                                          │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 片段化时间: [15] 分钟  │ 纯化方法: ▾ 磁珠法         │ │
│ │ 末端修复: ▾ 是        │ 连接效率: ▾ >90%           │ │
│ │ 片段筛选范围: [300-600] bp                         │ │
│ └─────────────────────────────────────────────────────┘ │
│                                                         │
│ 文库质量初步检测:                                      │
│ ┌──┬──────┬────────────┬────────────┬────────────────┐ │
│ │  │ 样本 │ 平均片段(bp)│ 浓度(nM)   │     备注       │ │
│ ├──┼──────┼────────────┼────────────┼────────────────┤ │
│ │  │ S001 │    [450]   │   [12.5]   │                │ │
│ │  │ S002 │    [420]   │   [15.2]   │                │ │
│ │  │ S003 │    [380]   │    [8.7]   │   [浓度偏低]   │ │
│ └──┴──────┴────────────┴────────────┴────────────────┘ │
│                                                         │
│ 使用的试剂记录:                                        │
│ ┌─────────────────┬─────────┬─────────┬───────────────┐ │
│ │     试剂        │  批号   │ 使用量  │     状态      │ │
│ ├─────────────────┼─────────┼─────────┼───────────────┤ │
│ │ Tagment Buffer  │202405003│  50μl   │     ✅        │ │
│ │ PCR Mix         │202405004│  25μl   │     ✅        │ │
│ │ Index Primer    │202405005│  10μl   │     ✅        │ │
│ │ 磁珠            │202405006│  100μl  │     ✅        │ │
│ └─────────────────┴─────────┴─────────┴───────────────┘ │
│                                                         │
│ [上传电泳图] [上传质检报告] [记录异常]                │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 4. 实时数据记录功能

### 快速记录面板（固定在底部）
```
┌─────────────────────────────────────────────────────────┐
│ 快速记录 - PCR扩增步骤                   [隐藏] [设置]    │
├─────────────────────────────────────────────────────────┤
│ 样本: ▾ S001 ▾ S002 ▾ S003 ▾ 所有样本                  │
│                                                         │
│ 温度异常: [记录]     │ 仪器报警: [记录]                 │
│ 试剂问题: [记录]     │ 操作失误: [记录]                 │
│                                                         │
│ 快速备注: [_________________________________________]   │
│                                                         │
│ [拍照记录] [语音记录] [标记完成]                       │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 移动端优化界面（用于实验室平板）
```
┌─────────────────────────────────────────────────────────┐
│ 核酸提取 - S001                     [←返回] [保存]      │
├─────────────────────────────────────────────────────────┤
│ 样本信息:                                              │
│ S001 - 肿瘤组织DNA - 项目A                            │
│                                                         │
│ 浓度检测: ┌───┐                                        │
│           │215│ ng/μl                                 │
│           └───┘                                        │
│                                                         │
│ 纯度检测:                                              │
│ 260/280: ┌───┐    260/230: ┌───┐                      │
│          │1.8│             │2.0│                      │
│          └───┘             └───┘                      │
│                                                         │
│ 体积: ┌───┐ μl    总量: ┌───┐ μg                     │
│       │ 50│              │10.8│                       │
│       └───┘              └───┘                       │
│                                                         │
│ 质检结果: ● 合格 ○ 警告 ○ 不合格                      │
│                                                         │
│ [拍照] [扫描二维码] [下一样本]                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 5. 数据记录的技术实现

### 数据库设计增强
```sql
-- 实验步骤记录表
CREATE TABLE experiment_step_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    batch_id BIGINT NOT NULL,
    step_type ENUM('sample_prep', 'nucleic_extraction', 'pcr', 'library_prep', 'quantification', 'qc'),
    operator_id BIGINT,
    start_time DATETIME,
    end_time DATETIME,
    instrument_info JSON,
    reagent_info JSON,
    -- 通用参数
    parameters JSON,
    -- 样本级数据
    sample_data JSON,
    qc_status ENUM('pass', 'warning', 'fail'),
    attachments JSON COMMENT '附件文件路径',
    notes TEXT,
    draft_flag BOOLEAN DEFAULT FALSE COMMENT '是否为草稿',
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 实时记录表（用于快速记录）
CREATE TABLE experiment_realtime_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    batch_id BIGINT NOT NULL,
    step_type VARCHAR(50),
    sample_id BIGINT,
    record_type ENUM('note', 'alert', 'measurement', 'image'),
    content TEXT,
    value DECIMAL(10,2),
    unit VARCHAR(20),
    image_path VARCHAR(500),
    created_by BIGINT,
    created_time DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 前端数据记录组件
```javascript
// 实验数据记录管理器
class ExperimentDataRecorder {
  constructor(batchId, stepType) {
    this.batchId = batchId;
    this.stepType = stepType;
    this.draftData = this.loadDraft();
  }

  // 保存草稿
  saveDraft(data) {
    this.draftData = { ...this.draftData, ...data };
    localStorage.setItem(`draft_${this.batchId}_${this.stepType}`, 
      JSON.stringify(this.draftData));
    
    // 自动保存到服务器
    this.autoSaveToServer();
  }

  // 加载草稿
  loadDraft() {
    const localDraft = localStorage.getItem(`draft_${this.batchId}_${this.stepType}`);
    if (localDraft) {
      return JSON.parse(localDraft);
    }
    
    // 从服务器加载未完成的记录
    return this.loadUnfinishedRecord();
  }

  // 完成步骤记录
  async completeStep(finalData) {
    const completeData = { ...this.draftData, ...finalData, draft_flag: false };
    
    try {
      const response = await fetch('/api/experiment/records', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(completeData)
      });
      
      if (response.ok) {
        // 清除草稿
        localStorage.removeItem(`draft_${this.batchId}_${this.stepType}`);
        return true;
      }
    } catch (error) {
      console.error('完成步骤记录失败:', error);
      return false;
    }
  }

  // 快速记录
  quickRecord(type, content, sampleId = null) {
    const quickRecord = {
      batch_id: this.batchId,
      step_type: this.stepType,
      sample_id: sampleId,
      record_type: type,
      content: content,
      created_by: currentUser.id
    };

    // 立即发送到服务器
    this.sendQuickRecord(quickRecord);
  }
}
```

### 样本数据表格组件
```javascript
// 可编辑的样本数据表格
class EditableSampleTable {
  constructor(containerId, samples) {
    this.container = document.getElementById(containerId);
    this.samples = samples;
    this.data = {};
    this.render();
  }

  render() {
    this.container.innerHTML = `
      <table class="sample-data-table">
        <thead>
          <tr>
            <th>样本</th>
            <th>浓度(ng/μl)</th>
            <th>体积(μl)</th>
            <th>260/280</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          ${this.samples.map(sample => `
            <tr data-sample-id="${sample.id}">
              <td>${sample.name}</td>
              <td>
                <input type="number" step="0.1" 
                  value="${this.data[sample.id]?.concentration || ''}"
                  onchange="table.updateField('${sample.id}', 'concentration', this.value)">
              </td>
              <td>
                <input type="number" step="1"
                  value="${this.data[sample.id]?.volume || ''}"
                  onchange="table.updateField('${sample.id}', 'volume', this.value)">
              </td>
              <td>
                <input type="number" step="0.01"
                  value="${this.data[sample.id]?.od260280 || ''}"
                  onchange="table.updateField('${sample.id}', 'od260280', this.value)">
              </td>
              <td>
                <button onclick="table.retest('${sample.id}')">重测</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  updateField(sampleId, field, value) {
    if (!this.data[sampleId]) {
      this.data[sampleId] = {};
    }
    this.data[sampleId][field] = value;
    
    // 自动验证数据
    this.validateSample(sampleId);
  }

  validateSample(sampleId) {
    const sampleData = this.data[sampleId];
    if (!sampleData) return;

    const warnings = [];
    
    if (sampleData.concentration < 10) {
      warnings.push('浓度偏低');
    }
    if (sampleData.od260280 < 1.8 || sampleData.od260280 > 2.2) {
      warnings.push('纯度异常');
    }

    // 更新行样式显示警告
    this.updateRowStyle(sampleId, warnings);
  }

  getData() {
    return this.data;
  }
}
```

## 6. 数据验证和质量控制

### 实时数据验证
```javascript
// 数据验证规则
const validationRules = {
  nucleic_extraction: {
    concentration: { min: 10, max: 500, required: true },
    volume: { min: 10, max: 200, required: true },
    od260280: { min: 1.8, max: 2.2, required: true }
  },
  pcr: {
    reaction_volume: { min: 10, max: 100, required: true },
    cycle_number: { min: 20, max: 40, required: true }
  },
  library_prep: {
    fragment_size: { min: 200, max: 700, required: true },
    concentration: { min: 2, max: 100, required: true }
  }
};

// 实时验证函数
function validateStepData(stepType, data) {
  const rules = validationRules[stepType];
  const errors = [];
  const warnings = [];

  for (const [field, rule] of Object.entries(rules)) {
    const value = data[field];
    
    if (rule.required && (value === undefined || value === null || value === '')) {
      errors.push(`${field} 是必填字段`);
      continue;
    }

    if (value !== undefined && value !== null) {
      if (rule.min !== undefined && value < rule.min) {
        warnings.push(`${field} 值偏低: ${value} < ${rule.min}`);
      }
      if (rule.max !== undefined && value > rule.max) {
        warnings.push(`${field} 值偏高: ${value} > ${rule.max}`);
      }
    }
  }

  return { isValid: errors.length === 0, errors, warnings };
}
```

这样的设计确保了：

✅ **完整的数据记录**：每个步骤都有专门的记录表单
✅ **实时记录支持**：实验过程中可以随时记录
✅ **草稿保存**：支持分多次完成记录
✅ **数据验证**：实时验证数据合理性
✅ **移动端友好**：适配实验室平板使用
✅ **附件管理**：支持图片、文件等附件上传
✅ **批量操作**：提高数据录入效率

实验人员可以在实验过程中方便地记录各项数据，系统会自动保存草稿、验证数据合理性，确保实验记录的完整性和准确性。