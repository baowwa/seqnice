import{j as e}from"./index-DyvGJ5NW.js";import{a}from"./react-vendor-DKSb2WWV.js";import{L as l}from"./LuckySheetTable-j_x_QN_q.js";import{a0 as t,s,S as i,B as n,a as r,a1 as c,T as d,l as o,c as m,e as p,a2 as h,a3 as x,a4 as u,W as j,a5 as y,a6 as v,a7 as g,a8 as b,D as C,a9 as T,aa as w,ab as k,ac as I}from"./antd-vendor-CqkZOb36.js";const{Title:N,Paragraph:S}=d,f=()=>{const[d,S]=a.useState([]),[f,D]=a.useState(!1),[z,_]=a.useState(()=>Array.from({length:5}).map((e,a)=>({id:`row-${a+1}`,sampleCode:"",sampleType:"",source:"",collectionDate:void 0,location:"",remarks:"",status:"pending",createTime:(new Date).toISOString(),updateTime:(new Date).toISOString()}))),[L]=t.useForm(),[U]=t.useForm(),[A,O]=a.useState("composite"),[$,F]=a.useState(!1),[B,M]=a.useState(null),[Y,E]=a.useState([{id:1,itemCode:"",itemName:"",sampleType:"",methodology:""},{id:2,itemCode:"",itemName:"",sampleType:"",methodology:""},{id:3,itemCode:"",itemName:"",sampleType:"",methodology:""}]),[J,R]=a.useState([{id:1,barcode:"",collectDate:void 0,count:1,kind:"",status:""}]),P=a.useCallback((e,a,l)=>{E(t=>t.map(t=>t.id===e?{...t,[a]:l}:t))},[]),K=a.useCallback((e,a)=>{var l;if("add"===e){const e=((null==(l=Y[Y.length-1])?void 0:l.id)||0)+1;E(a=>[...a,{id:e,itemCode:"",itemName:"",sampleType:"",methodology:""}])}else"remove"===e&&null!=a&&E(e=>e.filter(e=>e.id!==a))},[Y]),q=a.useCallback((e,a,l)=>{R(t=>t.map(t=>t.id===e?{...t,[a]:l}:t))},[]),G=a.useCallback((e,a)=>{var l;if("add"===e){const e=((null==(l=J[J.length-1])?void 0:l.id)||0)+1;R(a=>[...a,{id:e,barcode:"",collectDate:void 0,count:1,kind:"",status:""}])}else"remove"===e&&null!=a&&R(e=>e.filter(e=>e.id!==a))},[J]),H="sample_list",V=a.useMemo(()=>{try{const e=new URLSearchParams(window.location.search).get("mode")||"single";return["single","scan","table","batch"].includes(e)?e:"single"}catch{return"single"}},[]),W=a.useCallback(()=>{try{if(window.opener)return void window.close()}catch{}window.location.href="/sample/list"},[]),[Z,Q]=a.useState(!0),X=a.useCallback(async e=>{var a,l,t,i;try{const n=localStorage.getItem(H),r=n?JSON.parse(n):[],c={id:`SINGLE-${Date.now()}`,sampleBarcode:e.sampleBarcode,sampleCount:e.sampleCount,sampleSource:e.sampleSource||e.source,sampleDesc:e.sampleDesc||e.remarks,patientSex:e.patientSex,sampleCategory:e.sampleCategory||e.sampleType,collectionTime:(null==(l=null==(a=e.collectionTime)?void 0:a.format)?void 0:l.call(a,"YYYY-MM-DD"))||e.collectionDate,patientName:e.patientName,patientAge:e.patientAge,receiver:e.receiver,labDept:e.labDept,receiveTime:(null==(i=null==(t=e.receiveTime)?void 0:t.format)?void 0:i.call(t,"YYYY-MM-DD HH:mm"))||e.receiveTime,sendUnit:e.sendUnit,sender:e.sender,senderPhone:e.senderPhone,projectName:e.projectName||e.testName||e.testCode,projectType:e.projectType,testItems:Y,sampleKinds:J,status:"启用"};localStorage.setItem(H,JSON.stringify([c,...r])),s.success("样本已保存（已写入本地列表）"),L.resetFields(),Z&&(E([{id:1,itemCode:"",itemName:"",sampleType:"",methodology:""}]),R([{id:1,barcode:"",collectDate:void 0,count:1,kind:"",status:""}]))}catch(n){s.error("写入本地样本数据失败")}},[L,Z,Y,J]);a.useCallback(async e=>{await X(e),s.info("已触发标签打印（占位）")},[X]);const ee=a.useCallback(e=>{if(!e)return;if(d.some(a=>a.code===e))return void s.warning("该样本已在列表中");const a=le(e,A),l=U.getFieldsValue();S(t=>[...t,{code:a.sampleCode||e,type:a.sampleType||l.sampleType,source:a.source,receiveTime:a.receiveTime||l.receiveTime,receiver:a.receiver||l.receiver,testName:a.testName||l.testName}])},[d]),ae=a.useCallback(async()=>{if(0!==d.length){try{const e=localStorage.getItem(H),a=e?JSON.parse(e):[],l=d.map(e=>({id:`SCAN-${e.code}-${Date.now()}`,sampleCode:e.code,sampleType:e.type,source:e.source,receiveTime:e.receiveTime,receiver:e.receiver,projectName:e.testName,status:"启用"}));localStorage.setItem(H,JSON.stringify([...l,...a])),s.success(`已保存 ${l.length} 个样本到本地列表`)}catch(e){s.error("写入本地样本数据失败")}S([])}else s.warning("请先扫码添加样本")},[d]),le=a.useCallback((e,a)=>{try{if("single"===a)return{sampleCode:e};if("composite"===a){if(e.trim().startsWith("{")){const a=JSON.parse(e);return{sampleCode:a.sample_code||a.sampleCode,sampleType:a.sample_type||a.sampleType,receiver:a.receiver,receiveTime:a.receive_time||a.receiveTime,source:a.sample_source||a.source,testName:a.test_name||a.testName}}const a=e.split("?");if(a.length>1){const e=new URLSearchParams(a[1]);return{sampleCode:e.get("sample_code")||e.get("sampleCode")||void 0,sampleType:e.get("sample_type")||e.get("sampleType")||void 0,receiver:e.get("receiver")||void 0,receiveTime:e.get("receive_time")||void 0,source:e.get("sample_source")||e.get("source")||void 0,testName:e.get("test_name")||e.get("testName")||void 0}}const l=e.split(/[;|&]/),t={};return l.forEach(e=>{const[a,l]=e.split("=");a&&l&&(t[a.trim()]=decodeURIComponent(l.trim()))}),{sampleCode:t.sample_code||t.sampleCode,sampleType:t.sample_type||t.sampleType,receiver:t.receiver,receiveTime:t.receive_time||t.receiveTime,source:t.sample_source||t.source,testName:t.test_name||t.testName}}if("gs1"===a){const a=[...e.matchAll(/\((\d{2})\)([^\(\)]*)/g)],l={};return a.forEach(e=>{l[e[1]]=e[2]}),{sampleCode:l[21],source:l[10],receiveTime:l[17]}}return{sampleCode:e}}catch(l){return{sampleCode:e}}},[]),te=a.useCallback(async e=>{s.success(`已接收文件：${e.name}（占位解析）`)},[]),se=a.useMemo(()=>({name:"file",multiple:!1,accept:".csv,.xlsx",showUploadList:!0,beforeUpload:async e=>{try{return D(!0),await te(e),!1}finally{D(!1)}}}),[te]),ie=a.useMemo(()=>[{title:"样本编码",dataIndex:"code",key:"code"},{title:"类型",dataIndex:"type",key:"type"},{title:"来源",dataIndex:"source",key:"source"},{title:"接收时间",dataIndex:"receiveTime",key:"receiveTime"},{title:"接收人",dataIndex:"receiver",key:"receiver"},{title:"检测项目",dataIndex:"testName",key:"testName"},{title:"操作",key:"action",render:(a,l)=>e.jsx(i,{children:e.jsx(n,{size:"small",onClick:()=>{M(l),F(!0)},children:"详情"})})}],[]),ne=a.useMemo(()=>[{key:"sampleCode",title:"样本编码",dataType:"text",required:!0,width:160,validation:{pattern:"^[A-Za-z0-9-]+$",message:"仅限字母数字与连字符"}},{key:"sampleType",title:"样本类型",dataType:"select",required:!0,width:140,options:["blood","saliva","tissue"]},{key:"source",title:"来源",dataType:"text",width:140},{key:"collectionDate",title:"采集日期",dataType:"date",width:140},{key:"location",title:"存放位置",dataType:"text",width:160},{key:"remarks",title:"备注",dataType:"textarea",width:200},{key:"status",title:"状态",dataType:"select",width:120,options:["pending","processing","completed"]}],[]),re=a.useCallback(async()=>{const e=z.filter(e=>!e.sampleCode||!e.sampleType);if(e.length>0)s.error(`请完善必填字段：样本编码/样本类型（剩余 ${e.length} 行）`);else try{const e=localStorage.getItem(H),a=e?JSON.parse(e):[],l=z.map(e=>({id:`TABLE-${e.sampleCode||e.id}-${Date.now()}`,sampleCode:e.sampleCode,sampleType:e.sampleType,source:e.source,receiveTime:e.receiveTime,receiver:e.receiver,projectName:e.projectName||e.projectCode||e.testCode,status:"pending"===e.status?"启用":e.status}));localStorage.setItem(H,JSON.stringify([...l,...a])),s.success(`已保存 ${l.length} 条样本到本地列表`)}catch(a){s.error("写入本地样本数据失败")}},[z]);return e.jsx(i,{direction:"vertical",size:16,style:{width:"100%"},children:e.jsx(e.Fragment,{children:e.jsx(r,{children:e.jsx(c,{tabBarExtraContent:{right:e.jsx(n,{onClick:W,children:"返回列表"})},defaultActiveKey:V,onChange:()=>{},items:[{key:"single",label:"单个录入",children:e.jsxs(i,{direction:"vertical",size:16,style:{width:"100%"},children:[e.jsxs(i,{align:"center",style:{justifyContent:"space-between",width:"100%"},children:[e.jsxs(i,{align:"center",children:[e.jsx(N,{level:5,style:{margin:0},children:"样本信息录入"}),e.jsxs(i,{size:8,style:{marginLeft:16},children:[e.jsx(o,{checked:Z,onChange:Q}),e.jsx("span",{children:"自动转到下一条"})]})]}),e.jsxs(i,{children:[e.jsx(n,{type:"primary",onClick:()=>{L.validateFields().then(e=>X(e))},children:"提交"}),e.jsx(n,{onClick:()=>{L.validateFields().then(e=>(s.success("免审提交（占位）"),X(e)))},children:"免审提交"}),e.jsx(n,{onClick:()=>{L.validateFields().then(e=>X(e))},children:"保存"})]})]}),e.jsx(t,{form:L,layout:"horizontal",size:"small",labelAlign:"right",labelCol:{span:8},wrapperCol:{span:16},colon:!1,onFinish:X,children:e.jsxs(i,{direction:"vertical",size:16,style:{width:"100%"},children:[e.jsx(r,{title:"样本信息",size:"small",children:e.jsxs(m,{gutter:12,children:[e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"样本条码",name:"sampleBarcode",rules:[{required:!0,message:"请输入样本条码"}],children:e.jsx(h,{placeholder:"请填写"})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"样本大类",name:"sampleCategory",children:e.jsx(x,{options:[{label:"血液",value:"血液"},{label:"唾液",value:"唾液"},{label:"组织",value:"组织"}]})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"样本数量",name:"sampleCount",children:e.jsx(h,{type:"number",placeholder:"请输入"})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"样本采集时间",name:"collectionTime",children:e.jsx(u,{style:{width:"100%"}})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"样本来源",name:"sampleSource",children:e.jsx(h,{placeholder:"请填写"})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"患者姓名",name:"patientName",children:e.jsx(h,{placeholder:"请填写"})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"样本描述",name:"sampleDesc",children:e.jsx(h,{placeholder:"请填写"})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"患者年龄",name:"patientAge",children:e.jsx(h,{type:"number",placeholder:"岁"})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"患者性别",name:"patientSex",children:e.jsx(x,{options:[{label:"男",value:"男"},{label:"女",value:"女"}]})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"接收人姓名",name:"receiver",children:e.jsx(h,{placeholder:"请填写"})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"接收日期",name:"receiveTime",children:e.jsx(u,{style:{width:"100%"}})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"送检单位",name:"sendUnit",children:e.jsx(h,{placeholder:"请填写"})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"检验科室",name:"labDept",children:e.jsx(h,{placeholder:"请填写"})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"送检人",name:"sender",children:e.jsx(h,{placeholder:"请填写"})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"送检人联系方式",name:"senderPhone",children:e.jsx(h,{placeholder:"请输入手机号"})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"项目名称",name:"projectName",children:e.jsx(h,{placeholder:"请选择或输入"})})}),e.jsx(p,{span:12,children:e.jsx(t.Item,{label:"项目类型",name:"projectType",children:e.jsx(h,{placeholder:"请选择或输入"})})})]})}),e.jsxs(m,{gutter:16,children:[e.jsx(p,{span:12,children:e.jsx(r,{size:"small",title:"检验项目",extra:e.jsx(n,{danger:!0,size:"small",onClick:()=>E([]),children:"批量删除"}),children:e.jsx(j,{size:"small",rowKey:"id",pagination:!1,dataSource:Y,scroll:{x:900,y:280},columns:[{title:"序号",dataIndex:"id",width:70},{title:"操作",width:90,render:(a,l)=>e.jsxs(i,{children:[e.jsx(n,{type:"text",icon:e.jsx(y,{}),onClick:()=>K("add")}),e.jsx(n,{type:"text",danger:!0,icon:e.jsx(v,{}),onClick:()=>K("remove",l.id)})]})},{title:"检验项目编号",dataIndex:"itemCode",render:(a,l)=>e.jsx(h,{value:l.itemCode,onChange:e=>P(l.id,"itemCode",e.target.value)})},{title:"检验项目",dataIndex:"itemName",render:(a,l)=>e.jsxs(i,{children:[e.jsx(h,{value:l.itemName,onChange:e=>P(l.id,"itemName",e.target.value)}),e.jsx(n,{type:"text",icon:e.jsx(g,{})})]})},{title:"样本类型",dataIndex:"sampleType",render:(a,l)=>e.jsx(x,{style:{width:"100%"},value:l.sampleType,onChange:e=>P(l.id,"sampleType",e),options:[{label:"血液",value:"血液"},{label:"唾液",value:"唾液"},{label:"组织",value:"组织"}]})},{title:"方法学",dataIndex:"methodology",render:(a,l)=>e.jsx(h,{value:l.methodology,onChange:e=>P(l.id,"methodology",e.target.value)})}]})})}),e.jsx(p,{span:12,children:e.jsx(r,{size:"small",title:"样本类型",children:e.jsx(j,{size:"small",rowKey:"id",pagination:!1,dataSource:J,scroll:{x:800,y:280},columns:[{title:"序号",dataIndex:"id",width:70},{title:"样本条码",dataIndex:"barcode",render:(a,l)=>e.jsx(h,{value:l.barcode,onChange:e=>q(l.id,"barcode",e.target.value)})},{title:"采样时间",dataIndex:"collectDate",render:(a,l)=>e.jsx(u,{style:{width:"100%"},value:l.collectDate,onChange:e=>q(l.id,"collectDate",e)})},{title:"样本数",dataIndex:"count",width:100,render:(a,l)=>e.jsx(h,{type:"number",value:l.count,onChange:e=>q(l.id,"count",Number(e.target.value))})},{title:"样本类型",dataIndex:"kind",render:(a,l)=>e.jsx(x,{style:{width:"100%"},value:l.kind,onChange:e=>q(l.id,"kind",e),options:[{label:"血清",value:"血清"},{label:"血浆",value:"血浆"},{label:"血液",value:"血液"}]})},{title:"样本状态",dataIndex:"status",render:(a,l)=>e.jsx(h,{value:l.status,onChange:e=>q(l.id,"status",e.target.value)})},{title:"操作",width:90,render:(a,l)=>e.jsxs(i,{children:[e.jsx(n,{type:"text",icon:e.jsx(y,{}),onClick:()=>G("add")}),e.jsx(n,{type:"text",danger:!0,icon:e.jsx(v,{}),onClick:()=>G("remove",l.id)})]})}]})})})]})]})})]})},{key:"scan",label:"扫码录入",children:e.jsxs(i,{direction:"vertical",size:16,style:{width:"100%"},children:[e.jsxs(i,{wrap:!0,children:[e.jsx(b,{value:A,onChange:e=>O(e),options:[{label:"单码",value:"single"},{label:"复合码",value:"composite"},{label:"多码关联",value:"multi"},{label:"GS1",value:"gs1"}]}),e.jsx(h.Search,{allowClear:!0,placeholder:"扫码或手动输入样本编码",enterButton:"添加",onSearch:e=>ee(e)}),e.jsx(n,{type:"primary",onClick:ae,children:"提交"})]}),e.jsx(r,{size:"small",title:"快速编辑（应用于缺省字段）",children:e.jsxs(t,{form:U,layout:"inline",children:[e.jsx(t.Item,{label:"样本类型",name:"sampleType",children:e.jsx(x,{style:{width:160},options:[{label:"血液",value:"blood"},{label:"唾液",value:"saliva"},{label:"组织",value:"tissue"}]})}),e.jsx(t.Item,{label:"接收时间",name:"receiveTime",children:e.jsx(u,{showTime:!0,style:{width:220}})}),e.jsx(t.Item,{label:"接收人",name:"receiver",children:e.jsx(h,{style:{width:160},placeholder:"如：张三"})}),e.jsx(t.Item,{label:"检测项目",name:"testName",children:e.jsx(h,{style:{width:200},placeholder:"如：肿瘤NGS"})})]})}),e.jsx(j,{size:"small",rowKey:"code",columns:ie,dataSource:d,pagination:{pageSize:10}}),e.jsx(C,{title:"扫码条目详情",open:$,onClose:()=>{F(!1),M(null)},width:560,children:e.jsxs(t,{layout:"vertical",initialValues:B||{},onFinish:e=>{S(a=>a.map(a=>a.code===(null==B?void 0:B.code)?{...B,...e}:a)),F(!1)},children:[e.jsx(t.Item,{label:"样本编码",name:"code",children:e.jsx(h,{disabled:!0})}),e.jsx(t.Item,{label:"样本类型",name:"type",children:e.jsx(x,{options:[{label:"血液",value:"blood"},{label:"唾液",value:"saliva"},{label:"组织",value:"tissue"}]})}),e.jsx(t.Item,{label:"来源",name:"source",children:e.jsx(h,{})}),e.jsx(t.Item,{label:"接收时间",name:"receiveTime",children:e.jsx(u,{showTime:!0,style:{width:"100%"}})}),e.jsx(t.Item,{label:"接收人",name:"receiver",children:e.jsx(h,{})}),e.jsx(t.Item,{label:"检测项目",name:"testName",children:e.jsx(h,{})}),e.jsxs(i,{children:[e.jsx(n,{type:"primary",htmlType:"submit",children:"保存"}),e.jsx(n,{onClick:()=>{F(!1),M(null)},children:"取消"})]})]})})]})},{key:"table",label:"批量表格录入",children:e.jsxs(i,{direction:"vertical",size:16,style:{width:"100%"},children:[e.jsx(T,{title:"Excel 表格视图（Luckysheet）",column:1,children:e.jsx(T.Item,{label:"说明",children:"支持原生复制/粘贴、矩阵编辑；数据与保存逻辑保持一致。"})}),e.jsx(l,{columns:ne.map(e=>({key:e.key,title:e.title,type:"date"===e.dataType?"date":"number"===e.dataType?"number":"text"})),data:z,onChange:e=>_(e)}),e.jsx(i,{children:e.jsx(n,{type:"primary",onClick:re,children:"保存全部"})})]})},{key:"batch",label:"批量导入",children:e.jsxs(i,{direction:"vertical",size:16,style:{width:"100%"},children:[e.jsx(i,{children:e.jsx(n,{icon:e.jsx(w,{}),onClick:()=>{const e=new Blob(["样本编码,样本类型,来源,采集日期,存放位置,备注\n"],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(e),l=document.createElement("a");l.href=a,l.download="样本录入批量模板.csv",l.click(),URL.revokeObjectURL(a)},children:"下载模板"})}),e.jsxs(k.Dragger,{...se,disabled:f,children:[e.jsx("p",{className:"ant-upload-drag-icon",children:e.jsx(I,{})}),e.jsx("p",{className:"ant-upload-text",children:"点击或拖拽文件到此区域进行上传"}),e.jsx("p",{className:"ant-upload-hint",children:"支持 .csv/.xlsx，大小建议 ≤ 10MB"})]})]})}]})})})})};export{f as default};
